<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AORTAX VISION — Abo Wateen Studio</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#001428">
<style>
  /* (CSS مختصر واحترافي: ظلامي + زركشي أزرق) */
  *{box-sizing:border-box;font-family: 'Tajawal',sans-serif}
  body{margin:0;background:linear-gradient(180deg,#020617,#071124);color:#e6eefb;min-height:100vh}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background: rgba(255,255,255,0.03);backdrop-filter: blur(8px)}
  .logo{color:#60a7ff;font-weight:700;letter-spacing:1px}
  nav a{color:#cddffb;margin-left:12px;text-decoration:none}
  main{padding:18px;max-width:980px;margin:0 auto}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:20px;border-radius:14px;box-shadow:0 6px 20px rgba(0,122,255,0.06)}
  h1{margin:0 0 8px;font-size:20px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  input[type="text"], textarea{width:100%;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,0.04);color:#e6eefb;outline:none}
  .btn{background:#007AFF;color:#fff;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .generated{margin-top:16px;display:flex;gap:12px;flex-wrap:wrap}
  .generated img{border-radius:12px;max-width:320px;width:100%;box-shadow:0 10px 30px rgba(0,122,255,0.12)}
  .gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:18px}
  .gitem img{width:100%;border-radius:10px;display:block}
  .small-muted{color:#9fb3d9;font-size:13px;margin-top:8px}
  .row{display:flex;gap:10px;align-items:center}
  footer{padding:18px;text-align:center;color:#9fb3d9;font-size:13px;margin-top:18px}
  @media(max-width:600px){.controls{flex-direction:column}}
</style>
</head>
<body>
<header>
  <div class="logo">AORTAX VISION</div>
  <nav>
    <a href="#studio">الاستوديو</a>
    <a href="#gallery">المعرض</a>
    <a href="#profile">حسابي</a>
  </nav>
</header>

<main>
  <section id="studio" class="card">
    <h1>استوديو الذكاء الاصطناعي — AORTAX VISION</h1>
    <p class="small-muted">اكتب الوصف بالعربية أو الإنجليزية — ثم اضغط <strong>توليد الصورة</strong>. (يدعم Pollinations: رابط مباشر)</p>

    <div style="margin-top:12px">
      <textarea id="userPrompt" rows="3" placeholder="مثال: فتاة جزائرية ترتدي ملابس تقليدية في شارع قديم عند غروب الشمس، تفاصيل: واقعية 8K، عدسة سينمائية"></textarea>

      <div class="controls">
        <button class="btn" onclick="onGenerate()">توليد الصورة</button>
        <button class="btn ghost" onclick="enhancePrompt()">حسن الوصف (محسن)</button>
        <button class="btn ghost" onclick="speakPrompt()">نطق الوصف</button>
        <button class="btn ghost" onclick="toggleDark()">وضع/نمط</button>
      </div>

      <div class="small-muted">نصيحة: أضف أسلوب، كاميرا، إضاءة، تفاصيل ألوان وزمن (مثال: "cinematic 50mm, volumetric light, ultra-detailed").</div>
    </div>

    <div id="output" class="generated"></div>
    <div style="margin-top:10px" id="actionsRow"></div>
  </section>

  <section id="gallery" class="card" style="margin-top:18px">
    <h1>المعرض المحلي</h1>
    <p class="small-muted">الصور التي ولّدتَها محفوظة هنا (محليًا في جهازك). يمكنك تنزيلها أو حذفها.</p>
    <div id="localGallery" class="gallery"></div>
  </section>

  <section id="profile" class="card" style="margin-top:18px">
    <h1>الملف الشخصي</h1>
    <div class="row" style="margin-top:8px">
      <div>مطور: Abo Wateen</div>
      <div style="margin-left:auto"><a href="https://instagram.com/okba_bzg" target="_blank" class="small-muted">@okba_bzg</a></div>
    </div>
  </section>

  <footer>© AORTAX VISION — Abo Wateen Studio</footer>
</main>

<script>
/* ==== إعدادات سريعة ==== */
const POLLINATIONS_BASE = 'https://image.pollinations.ai/prompt/';

/* ==== Prompt enhancer بسيط لكنه قوي ==== */
function enhancePrompt() {
  const el = document.getElementById('userPrompt');
  let txt = el.value.trim();
  if(!txt) { alert('اكتب وصفًا أولاً'); return; }

  // لو كان الوصف بالعربي نحاول نضيف كلمات إنجليزية فنية أيضاً
  const add = [
    'ultra-detailed','photorealistic','8k','cinematic lighting',
    'award-winning composition','soft volumetric light','shallow depth of field'
  ];

  // نركب جملة محسنّة
  let enhanced = txt;
  // إذا الوصف قصير، نضيف prompt template
  if(txt.split(' ').length < 6) {
    enhanced += ' — photorealistic, dramatic light, ultra-detailed, 50mm';
  } else {
    enhanced += ', ' + add.slice(0,3).join(', ');
  }

  // نحط الاقتراح للمستخدم ويعرض في مربع النص
  el.value = enhanced;
}

/* ==== تحويل النص إلى كلام (TTS) ==== */
function speakPrompt() {
  const txt = document.getElementById('userPrompt').value.trim();
  if(!txt){ alert('اكتب وصفًا أولاً'); return; }
  if('speechSynthesis' in window) {
    const ut = new SpeechSynthesisUtterance(txt);
    // اختر لغة عربية أو إنجليزية تلقائيًا حسب الحروف
    ut.lang = /[ا-ي]/.test(txt) ? 'ar-SA' : 'en-US';
    speechSynthesis.cancel();
    speechSynthesis.speak(ut);
  } else alert('لم يتم العثور على دعم النطق في متصفحك');
}

/* ==== توليد الصورة من Pollinations وعرضها ==== */
async function onGenerate() {
  const prompt = document.getElementById('userPrompt').value.trim();
  if(!prompt) return alert('اكتب وصفًا أولاً');
  const encoded = encodeURIComponent(prompt);
  const url = POLLINATIONS_BASE + encoded;

  // عرض تحميل مؤقت
  const out = document.getElementById('output');
  out.innerHTML = '<div style="padding:12px;color:#9fb3d9">جاري التحميل...</div>';

  // نعرض الصورة مباشرة عبر url (Pollinations يوفر صورة عند فتح الرابط)
  // لكن للتحكم في التنزيل نحمل الـ blob ثم نعرضه
  try {
    const r = await fetch(url, {mode:'cors'});
    if(!r.ok) throw new Error('خطأ في توليد الصورة: ' + r.status);
    const blob = await r.blob();
    const blobUrl = URL.createObjectURL(blob);
    out.innerHTML = `<img id="lastImg" src="${blobUrl}" alt="AI image">`;

    // أزرار: تنزيل - حفظ للمعرض - إعادة تحسين
    const actions = document.getElementById('actionsRow');
    actions.innerHTML = `
      <button class="btn" onclick="downloadBlob()">تنزيل الصورة</button>
      <button class="btn ghost" onclick="saveToGallery()">حفظ للمعرض</button>
      <button class="btn ghost" onclick="enhancedRegenerate()">تحسين وإعادة توليد</button>
    `;

    // خزن آخر blob في متغير مؤقت
    window.__lastBlob = blob;
    window.__lastPrompt = prompt;
  } catch(err) {
    out.innerHTML = '<div style="color:#f88">فشل تحميل الصورة — ' + err.message + '</div>';
    console.error(err);
  }
}

/* ==== تنزيل الـ blob الحالي === */
function downloadBlob() {
  const blob = window.__lastBlob;
  if(!blob) return alert('لا توجد صورة للتنزيل');
  const a = document.createElement('a');
  const url = URL.createObjectURL(blob);
  a.href = url;
  const safeName = (window.__lastPrompt||'aortax-image').slice(0,30).replace(/[^a-z0-9\- ]/ig,'_');
  a.download = safeName + '.png';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ==== حفظ محليًا في LocalStorage كـ data URL (معرض محلي) ==== */
async function saveToGallery() {
  const blob = window.__lastBlob;
  if(!blob) return alert('لا توجد صورة للحفظ');
  // نقرأ blob كـ data URL
  const reader = new FileReader();
  reader.onload = function() {
    const dataURL = reader.result;
    const gallery = JSON.parse(localStorage.getItem('aortax_gallery')||'[]');
    gallery.unshift({id: Date.now(), prompt: window.__lastPrompt || '', data: dataURL});
    localStorage.setItem('aortax_gallery', JSON.stringify(gallery.slice(0,50)));
    renderGallery();
    alert('تم الحفظ في المعرض المحلي');
  };
  reader.readAsDataURL(blob);
}

/* ==== إعادة توليد محسّنة تلقائياً (نضيف كلمات فنية أقوى) ==== */
function enhancedRegenerate() {
  const p = document.getElementById('userPrompt');
  p.value = p.value + ', hyper-realistic, cinematic, studio light, ultra-detailed';
  onGenerate();
}

/* ==== عرض المعرض المحلي ==== */
function renderGallery() {
  const gallery = JSON.parse(localStorage.getItem('aortax_gallery')||'[]');
  const container = document.getElementById('localGallery');
  container.innerHTML = '';
  if(!gallery.length){ container.innerHTML = '<div class="small-muted">لا توجد صور محفوظة بعد.</div>'; return; }
  for(const item of gallery) {
    const div = document.createElement('div');
    div.className = 'gitem';
    div.innerHTML = `
      <img src="${item.data}" alt="">
      <div class="small-muted" style="margin-top:6px">
        ${escapeHtml(item.prompt || '')}
        <div style="margin-top:6px">
          <button class="btn ghost" onclick='downloadData("${item.id}")'>تنزيل</button>
          <button class="btn ghost" onclick='removeFromGallery("${item.id}")'>حذف</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  }
}
function downloadData(id) {
  const gallery = JSON.parse(localStorage.getItem('aortax_gallery')||'[]');
  const item = gallery.find(i=>i.id==id);
  if(!item) return;
  const a = document.createElement('a');
  a.href = item.data;
  a.download = (item.prompt||'aortax').slice(0,30).replace(/[^a-z0-9\- ]/ig,'_') + '.png';
  document.body.appendChild(a);
  a.click();
  a.remove();
}
function removeFromGallery(id) {
  let gallery = JSON.parse(localStorage.getItem('aortax_gallery')||'[]');
  gallery = gallery.filter(i=>i.id!=id);
  localStorage.setItem('aortax_gallery', JSON.stringify(gallery));
  renderGallery();
}

/* ==== حماية وحيل صغيرة ==== */
function escapeHtml(t){ return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ==== Dark mode toggle بسيط ==== */
function toggleDark(){
  document.body.classList.toggle('light-mode');
  if(document.body.classList.contains('light-mode')){
    document.body.style.background = 'linear-gradient(180deg,#f6fbff,#dfeeff)';
    document.body.style.color = '#0a1f3b';
  } else {
    document.body.style.background = 'linear-gradient(180deg,#020617,#071124)';
    document.body.style.color = '#e6eefb';
  }
}

/* ==== register service worker إذا سمح المتصفح ==== */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/service-worker.js').catch(e=>console.warn('SW fail',e));
}

/* ==== Init ==== */
renderGallery();

</script>
</body>
</html>
